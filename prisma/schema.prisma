// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["postgresqlExtensions"]
}

datasource db {
    provider   = "postgresql"
    url        = env("DATABASE_URL")
    extensions = [vector]
}

// 文档类型枚举
enum DocumentType {
    API_DOC // API接口文档
    TECH_DOC // 技术实现文档
    CODE_LOGIC_DOC // 内部代码逻辑文档
    GENERAL_DOC // 通用文档
}

// 原始文档表
model Document {
    id          String       @id @default(uuid())
    title       String? // 文档标题
    content     String // 原始文档内容（纯文本）
    type        DocumentType // 文档类型
    projectName String // 所属项目名称
    metadata    Json? // 额外元数据
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt

    // 关联的父切片
    parentChunks ParentChunk[]

    @@index([projectName])
    @@index([type])
    @@map("documents")
}

// 切割策略表 - 记录使用的切割配置（父子索引）
model ChunkStrategy {
    id              String   @id @default(uuid())
    parentChunkSize Int // 父块大小（字符数）
    childChunkSize  Int // 子块大小（字符数）
    overlapPercent  Int // 重叠百分比（0-100）
    name            String? // 策略名称
    createdAt       DateTime @default(now())

    // 使用此策略的父切片
    parentChunks ParentChunk[]

    @@unique([parentChunkSize, childChunkSize, overlapPercent])
    @@map("chunk_strategies")
}

// 父切片表 - 存储较大的文档片段（用于检索上下文）
model ParentChunk {
    id            String   @id @default(uuid())
    content       String // 父切片内容
    parentIndex   Int // 在原文档中的序号
    startPosition Int // 在原文档中的起始位置
    endPosition   Int // 在原文档中的结束位置
    summary       String? // 父切片摘要
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // 关联原始文档
    documentId String
    document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

    // 关联切割策略
    strategyId String
    strategy   ChunkStrategy @relation(fields: [strategyId], references: [id])

    // 关联的子切片
    childChunks ChildChunk[]

    @@index([documentId])
    @@index([strategyId])
    @@map("parent_chunks")
}

// 子切片表 - 存储较小的文档片段（用于向量检索）
model ChildChunk {
    id            String   @id @default(uuid())
    content       String // 子切片内容
    chunkIndex    Int // 在父切片中的序号
    startPosition Int // 在原文档中的起始位置
    endPosition   Int // 在原文档中的结束位置
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // 关联父切片
    parentChunkId String
    parentChunk   ParentChunk @relation(fields: [parentChunkId], references: [id], onDelete: Cascade)

    // 关联的向量嵌入
    embeddings ChunkEmbedding[]

    @@index([parentChunkId])
    @@map("child_chunks")
}

// 向量嵌入表 - 存储子切片的向量表示
model ChunkEmbedding {
    id            String                      @id @default(uuid())
    embedding     Unsupported("vector(3072)") // text-embedding-3-small 向量维度3072
    embeddingType String // 嵌入类型：content（原文内容）、summary（摘要）
    model         String // 使用的嵌入模型
    createdAt     DateTime                    @default(now())

    // 关联子切片
    chunkId String
    chunk   ChildChunk @relation(fields: [chunkId], references: [id], onDelete: Cascade)

    @@index([chunkId])
    @@map("chunk_embeddings")
}
